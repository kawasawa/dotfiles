---
applyTo: "**"
description: "一貫性と品質を維持するため常に参照する共通規約"
---

# 共通規約

- 技術スタックを問わず全プロジェクトに適用
- 長考許容、精度優先
- 日本語で記述 (内部推論は英語、出力は日本語)

## 前提

- ユーザの指示やプロジェクト固有の規約、フレームワークの自動対応がある場合はそれを優先
- 不明点やトレードオフがある場合はユーザに確認
- 対象外領域には適用不要 (例: CLI に Cookie 設定は不要)

## 対話

- 簡潔、具体的、正確に回答
- 事実ベース、中立的に回答
- 最新かつ信頼できる情報を使用
- 十分な実績がある技術を優先

## 設計

優先順位: 項番順 > 実装ルール

### 1. セキュリティ

- **CIA triad** 順守
- **OWASP Top 10** (CSRF/XSS/SQLi 等) 対策
  - 入力値: バリデーション・サニタイズ
  - クエリ: パラメータ化
  - 出力値: エスケープ
  - Cookie: Secure/HttpOnly/SameSite=Lax or Strict
  - CSP (Content Security Policy) を適用
- IaaS の考慮
  - **PoLP**
  - **RBAC**
  - 転送データ暗号化 (TLS1.2+)
  - 保存データ暗号化 (AES256+)
  - メタデータアクセス制限 (IMDSv2+)

### 2. 品質特性 (ISO/IEC 25010)

- セキュリティ: 機密性/インテグリティ/否認防止性/責任追跡性/真正性を確保
- 保守性: モジュール性/再利用性/解析性/修正性/試験性を維持

### 3. 普遍的原則

- **SOLID** (SRP/OCP/LSP/ISP/DIP)
- **DRY**
- **KISS**
- **YAGNI**
- **PIE** (Program Intently and Expressively): 意図を明確に表現 (明確な命名、適切な型)
- **SLAP** (Single Level of Abstraction): 関数内の抽象度を統一 (高レベル操作と低レベル操作の混在を回避)
- **PLK** (Least Knowledge): サブオブジェクトに関する知識を排除
- **PLS** (Least Surprise): 予想し得ない動作を避ける
- **SoC** (Separation of Concerns): 関心事 (UI/App/Domain/Infra) の分離
- **CLEAN**: 高凝縮、疎結合、カプセル化、断定的 (**ドメインモデル貧血症** を回避)、非冗長
- **Early Return**: 異常系の早期排除
- **OFOP** (One Fact One Place): DB 設計は第三正規化まで (性能要件が厳しい場合は例外)
- **ACID**
  - 単一DB複数テーブルの同時更新はトランザクション内で実行
  - 分散DBや外部副作用はアウトボックス、補償トランザクション等を検討

## 実装

### 製品コード

- 言語/フレームワークのベストプラクティスに準拠
- デファクトスタンダードなパッケージを優先
- 関数にドキュメントコメント、処理ブロックに概要コメントを付与
- 機密情報はログ・レスポンスに含めず、クライアントで保持しない
- 考慮事項 (優先順位順):
  1. アクセシビリティ: **WCAG 2.2 AA** 準拠, **WAI-ARIA** 推奨
  2. オブザーバビリティ: 適切なログ・メトリクス・トレース
  3. パフォーマンス: CWV 推奨値 (LCP≤2.5s, INP≤100ms, CLS≤0.1)、可読性を損なう最適化は回避

### テストコード

- **AAA** (Arrange/Act/Assert) で実装
- カバレッジ目標: C0≥90%, C1≥80%
- エッジケースをカバー
- 依存関係のモック化:
  - UT (単体): 全て
  - IT (統合): 外部サービスのみ (内部モジュールは実際の実装を使用)

### リファクタリング

- 振る舞いを変えずに可読性・保守性・凝集度を改善
- 行き詰まった場合はユーザに確認
